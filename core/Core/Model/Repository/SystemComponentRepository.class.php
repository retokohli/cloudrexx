<?php

namespace Cx\Core\Core\Model\Repository;

use Doctrine\ORM\EntityRepository;

/**
 * SystemComponentRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class SystemComponentRepository extends EntityRepository
{
    protected $loadedComponents = array();
    protected $cx = null;
    
    public function __construct($em, \Doctrine\ORM\Mapping\ClassMetadata $class) {
        parent::__construct($em, $class);
        $this->cx = \Env::get('cx');
    }
    
    public function find($id, $lockMode = LockMode::NONE, $lockVersion = null) {
        return $this->decorate(parent::find($id, $lockMode, $lockVersion));
    }
    
    public function findAll() {
        return $this->decorate(parent::findAll());
    }
    
    public function findBy(array $criteria) {
        return $this->decorate(parent::findBy($criteria));
    }
    
    public function findOneBy(array $criteria) {
        return $this->decorate(parent::findOneBy($criteria));
    }
    
    protected function decorate($components) {
        if (!$components) {
            return $components;
        }
        
        if (!is_array($components)) {
            $yamlDir = $components->getDirectory().'/Model/Yaml';
            $this->cx->getDb()->addSchemaFileDirectories(array($yamlDir));
            $entity = $this->decorateEntity($components);
            return $entity;
        }
        
        $yamlDirs = array();
        foreach ($components as $component) {
            if (isset($this->loadedComponents[$component->getId()])) {
                continue;
            }
            $yamlDirs[] = $component->getDirectory().'/Model/Yaml';
        }
        
        $this->cx->getDb()->addSchemaFileDirectories($yamlDirs);
        foreach ($components as &$component) {
            if (isset($this->loadedComponents[$component->getId()])) {
                $component = $this->loadedComponents[$component->getId()];
                continue;
            }
            $component = $this->decorateEntity($component);
            \Cx\Core\Json\JsonData::addAdapter($component->getControllersAccessableByJson(), $component->getNamespace() . '\\Controller');
        }
        return $components;
    }
    
    /**
     *
     * @param \Cx\Core\Core\Model\Entity\SystemComponent $component
     * @return \Cx\Core\Core\Model\Entity\SystemComponentController
     */
    protected function decorateEntity(\Cx\Core\Core\Model\Entity\SystemComponent $component) {
        if (isset($this->loadedComponents[$component->getId()])) {
            return $this->loadedComponents[$component->getId()];
        }        
        $componentControllerClass = $this->getComponentControllerClassFor($component);
        $componentController = new $componentControllerClass($component, $this->cx);
        $this->loadedComponents[$component->getId()] = $componentController;
        return $componentController;
    }
    
    protected function getComponentControllerClassFor(\Cx\Core\Core\Model\Entity\SystemComponent $component) {
        if (!file_exists($component->getDirectory() . '/Controller/ComponentController.class.php')) {
            return '\\Cx\\Core\\Core\\Model\\Entity\\SystemComponentController';
        }
        $className = $component->getNamespace() . '\\Controller\\ComponentController';
        return $className;
    }
    
    public function callPreResolveHooks() {
        foreach ($this->findAll() as $component) {
            $component->preResolve($this->cx->getRequest());
        }
    }
    
    public function callPostResolveHooks() {
        foreach ($this->findAll() as $component) {
            $component->postResolve($this->cx->getPage());
        }
    }
    
    public function callPreContentLoadHooks() {
        foreach ($this->findAll() as $component) {
            $component->preContentLoad($this->cx->getPage());
        }
    }
    
    // NEW
    public function callPreContentParseHooks() {
        foreach ($this->findAll() as $component) {
            $component->preContentParse($this->cx->getPage());
        }
    }
    
    public function loadComponent($componentName) {
        $this->findOneBy(array('name'=>$componentName))->load($this->cx->getPage());
    }
    
    // NEW
    public function callPostContentParseHooks() {
        foreach ($this->findAll() as $component) {
            $component->postContentParse($this->cx->getPage());
        }
    }
    
    public function callPostContentLoadHooks() {
        foreach ($this->findAll() as $component) {
            $component->postContentLoad($this->cx->getPage());
        }
    }
    
    // NEW
    public function callPreFinalizeHooks() {
        foreach ($this->findAll() as $component) {
            $component->preFinalize($this->cx->getTemplate());
        }
    }
    
    // NEW
    public function callPostFinalizeHooks() {
        foreach ($this->findAll() as $component) {
            $component->postFinalize();
        }
    }
}